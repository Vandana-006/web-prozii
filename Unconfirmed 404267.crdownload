// server.js - Quiz Platform Backend (Node.js + Express)
// Complete REST API for student quiz system

const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const path = require('path');

const app = express();
const PORT = 3000;

// ==================== MIDDLEWARE ====================
app.use(cors());
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// Serve frontend files from 'public' folder
app.use(express.static(path.join(__dirname, 'public')));

// ==================== IN-MEMORY DATABASE ====================
let quizzes = [];
let students = [];
let quizAttempts = [];
let nextQuizId = 1;
let nextStudentId = 1;
let nextAttemptId = 1;

// ==================== HELPER FUNCTIONS ====================

// Calculate score percentage
function calculateScore(answers, correctAnswers) {
  let correct = 0;
  for (let i = 0; i < answers.length; i++) {
    if (answers[i] === correctAnswers[i]) {
      correct++;
    }
  }
  return Math.round((correct / answers.length) * 100);
}

// Grade assignment based on score
function getGrade(score) {
  if (score >= 90) return 'A+';
  if (score >= 80) return 'A';
  if (score >= 70) return 'B';
  if (score >= 60) return 'C';
  if (score >= 50) return 'D';
  return 'F';
}

// Get performance status
function getPerformanceStatus(score) {
  if (score >= 80) return 'Excellent ğŸŒŸ';
  if (score >= 70) return 'Good ğŸ‘';
  if (score >= 60) return 'Average ğŸ“Š';
  return 'Needs Improvement ğŸ’ª';
}

// ==================== ROUTES ====================

// Health check
app.get('/api', (req, res) => {
  res.json({ message: 'Quiz Platform API is running âœ…' });
});

// ========== STUDENT ENDPOINTS ==========

// Register student
app.post('/api/students', (req, res) => {
  const { name, email, rollNumber } = req.body;

  if (!name || !email || !rollNumber) {
    return res.status(400).json({ error: 'Name, email, and roll number required' });
  }

  // Check if email already exists
  const emailExists = students.find(s => s.email === email);
  if (emailExists) {
    return res.status(409).json({ error: 'Email already registered' });
  }

  const newStudent = {
    id: nextStudentId++,
    name,
    email,
    rollNumber,
    joinedAt: new Date(),
    totalQuizzesTaken: 0,
    averageScore: 0,
    bestScore: 0
  };

  students.push(newStudent);

  res.status(201).json({
    message: 'Student registered successfully âœ…',
    student: newStudent
  });
});

// Get all students
app.get('/api/students', (req, res) => {
  const studentsWithStats = students.map(student => {
    const studentAttempts = quizAttempts.filter(a => a.studentId === student.id);
    const scores = studentAttempts.map(a => a.score);
    
    return {
      ...student,
      totalQuizzesTaken: studentAttempts.length,
      averageScore: scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0,
      bestScore: scores.length > 0 ? Math.max(...scores) : 0
    };
  });

  res.json(studentsWithStats);
});

// Get single student
app.get('/api/students/:id', (req, res) => {
  const id = Number(req.params.id);
  const student = students.find(s => s.id === id);

  if (!student) {
    return res.status(404).json({ error: 'Student not found' });
  }

  const studentAttempts = quizAttempts.filter(a => a.studentId === id);
  const scores = studentAttempts.map(a => a.score);

  const studentWithStats = {
    ...student,
    totalQuizzesTaken: studentAttempts.length,
    averageScore: scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0,
    bestScore: scores.length > 0 ? Math.max(...scores) : 0,
    attempts: studentAttempts
  };

  res.json(studentWithStats);
});

// ========== QUIZ ENDPOINTS ==========

// CREATE quiz
app.post('/api/quizzes', (req, res) => {
  const { title, subject, duration, totalQuestions, questions } = req.body;

  if (!title || !subject || !questions || questions.length === 0) {
    return res.status(400).json({ error: 'Title, subject, and questions required' });
  }

  const newQuiz = {
    id: nextQuizId++,
    title,
    subject,
    duration: duration || 30,
    totalQuestions: questions.length,
    questions, // Array of {question, options[], correctAnswer, difficulty}
    createdAt: new Date(),
    totalAttempts: 0,
    averageScore: 0
  };

  quizzes.push(newQuiz);

  res.status(201).json({
    message: 'Quiz created successfully âœ…',
    quiz: newQuiz
  });
});

// READ all quizzes
app.get('/api/quizzes', (req, res) => {
  const quizzesWithStats = quizzes.map(quiz => {
    const attempts = quizAttempts.filter(a => a.quizId === quiz.id);
    const scores = attempts.map(a => a.score);

    return {
      ...quiz,
      totalAttempts: attempts.length,
      averageScore: scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0,
      // Don't send correct answers in list view
      questions: quiz.questions.map(q => ({
        question: q.question,
        options: q.options,
        difficulty: q.difficulty
      }))
    };
  });

  res.json(quizzesWithStats);
});

// READ single quiz
app.get('/api/quizzes/:id', (req, res) => {
  const id = Number(req.params.id);
  const quiz = quizzes.find(q => q.id === id);

  if (!quiz) {
    return res.status(404).json({ error: 'Quiz not found' });
  }

  const attempts = quizAttempts.filter(a => a.quizId === id);
  const scores = attempts.map(a => a.score);

  const quizWithStats = {
    ...quiz,
    totalAttempts: attempts.length,
    averageScore: scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b) / scores.length) : 0
  };

  res.json(quizWithStats);
});

// UPDATE quiz
app.put('/api/quizzes/:id', (req, res) => {
  const id = Number(req.params.id);
  const quiz = quizzes.find(q => q.id === id);

  if (!quiz) {
    return res.status(404).json({ error: 'Quiz not found' });
  }

  const { title, subject, duration, questions } = req.body;

  if (title) quiz.title = title;
  if (subject) quiz.subject = subject;
  if (duration) quiz.duration = duration;
  if (questions) quiz.questions = questions;

  res.json({
    message: 'Quiz updated successfully âœ…',
    quiz
  });
});

// DELETE quiz
app.delete('/api/quizzes/:id', (req, res) => {
  const id = Number(req.params.id);
  const index = quizzes.findIndex(q => q.id === id);

  if (index === -1) {
    return res.status(404).json({ error: 'Quiz not found' });
  }

  const deleted = quizzes.splice(index, 1)[0];

  res.json({
    message: 'Quiz deleted successfully âœ…',
    quiz: deleted
  });
});

// ========== QUIZ SUBMISSION & SCORING ==========

// Submit quiz answers
app.post('/api/quizzes/:quizId/submit', (req, res) => {
  const quizId = Number(req.params.quizId);
  const { studentId, answers, timeTaken } = req.body;

  const quiz = quizzes.find(q => q.id === quizId);
  if (!quiz) {
    return res.status(404).json({ error: 'Quiz not found' });
  }

  const student = students.find(s => s.id === studentId);
  if (!student) {
    return res.status(404).json({ error: 'Student not found' });
  }

  // Calculate score
  const correctAnswers = quiz.questions.map(q => q.correctAnswer);
  const score = calculateScore(answers, correctAnswers);
  const grade = getGrade(score);
  const status = getPerformanceStatus(score);

  // Get correct count
  let correctCount = 0;
  for (let i = 0; i < answers.length; i++) {
    if (answers[i] === correctAnswers[i]) {
      correctCount++;
    }
  }

  const attempt = {
    id: nextAttemptId++,
    quizId,
    studentId,
    answers,
    score,
    grade,
    status,
    correctCount,
    totalQuestions: quiz.totalQuestions,
    timeTaken: timeTaken || 0,
    submittedAt: new Date()
  };

  quizAttempts.push(attempt);

  res.status(201).json({
    message: 'Quiz submitted successfully! ğŸ‰',
    attempt
  });
});

// GET quiz answer sheet (for review)
app.get('/api/quizzes/:quizId/review/:attemptId', (req, res) => {
  const quizId = Number(req.params.quizId);
  const attemptId = Number(req.params.attemptId);

  const quiz = quizzes.find(q => q.id === quizId);
  if (!quiz) {
    return res.status(404).json({ error: 'Quiz not found' });
  }

  const attempt = quizAttempts.find(a => a.id === attemptId && a.quizId === quizId);
  if (!attempt) {
    return res.status(404).json({ error: 'Attempt not found' });
  }

  // Build detailed review with correct answers
  const review = quiz.questions.map((q, index) => ({
    questionNumber: index + 1,
    question: q.question,
    options: q.options,
    studentAnswer: attempt.answers[index],
    correctAnswer: q.correctAnswer,
    isCorrect: attempt.answers[index] === q.correctAnswer,
    difficulty: q.difficulty,
    explanation: q.explanation || ''
  }));

  res.json({
    quizTitle: quiz.title,
    studentId: attempt.studentId,
    score: attempt.score,
    grade: attempt.grade,
    correctCount: attempt.correctCount,
    totalQuestions: attempt.totalQuestions,
    review
  });
});

// ========== STATISTICS & ANALYTICS ==========

// Get student quiz history
app.get('/api/students/:studentId/attempts', (req, res) => {
  const studentId = Number(req.params.studentId);

  const attempts = quizAttempts.filter(a => a.studentId === studentId);
  if (attempts.length === 0) {
    return res.json({
      message: 'No attempts yet',
      attempts: []
    });
  }

  res.json({
    totalAttempts: attempts.length,
    averageScore: Math.round(attempts.reduce((sum, a) => sum + a.score, 0) / attempts.length),
    bestScore: Math.max(...attempts.map(a => a.score)),
    worstScore: Math.min(...attempts.map(a => a.score)),
    attempts: attempts.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt))
  });
});

// Get overall platform statistics
app.get('/api/stats/platform', (req, res) => {
  const totalStudents = students.length;
  const totalQuizzes = quizzes.length;
  const totalAttempts = quizAttempts.length;
  const averageScore = totalAttempts > 0 ? Math.round(quizAttempts.reduce((sum, a) => sum + a.score, 0) / totalAttempts) : 0;

  const subjectStats = {};
  quizzes.forEach(quiz => {
    if (!subjectStats[quiz.subject]) {
      subjectStats[quiz.subject] = { count: 0, totalScore: 0, attempts: 0 };
    }
    subjectStats[quiz.subject].count++;
    
    const attempts = quizAttempts.filter(a => a.quizId === quiz.id);
    subjectStats[quiz.subject].attempts += attempts.length;
    attempts.forEach(a => {
      subjectStats[quiz.subject].totalScore += a.score;
    });
  });

  res.json({
    totalStudents,
    totalQuizzes,
    totalAttempts,
    averageScore,
    subjectStats
  });
});

// ==================== ERROR HANDLERS ====================

// 404 handler
app.use((req, res) => {
  res.status(404).json({ error: 'Route not found' });
});

// Error handler middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Internal server error' });
});

// ==================== START SERVER ====================

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘    Quiz Platform API Running ğŸ“       â•‘
â•‘    Server: http://localhost:${PORT}   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

module.exports = app;
